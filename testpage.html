<html>

<body>
    <div>
        <p>This is first paragraph!</p>
        <p>This is second paragraph!</p>
    </div>
    <div id="confirm-annotation-box" style="border:1px solid black; position:absolute; top:10px; display: none">
        <form>
            <input type="button" value="Annotate?" onclick="confirmAnnotation();" />
        </form>
    </div>
    <div id="annotation-box" style="border:1px solid black; position:absolute; top:10px; display: none">
        <form>
            <input type="text" id="annotation-comment" />
            <input type="button" value="Send annotation!" onclick="sendAnnotation();" />
            <input type="button" value="Cancel annotation!" onclick="cancelAnnotation();" />
        </form>
    </div>
</body>
<script src="annotation-model.js"></script>
<script>

    document.addEventListener("selectionchange", function () {
        // var selection = window.getSelection();
        // console.log('Selection changed.', selection);
        // var ab = new AnnotationBuilder().highlight(); //takes current user selection and builds an Annotation
        // var json = JSON.stringify(ab.result, false, '  '); // exports serialized version to JSON-LD
        // var output = document.getElementById('output');
        // output.value = json;
        // console.log(json)

        //  var ab2 = new AnnotationBuilder().fromJSON(json); //revives serialized version 
        //   ab2.result.target.toSelection();
        // console.log(selection.toString());

    });

    var annotationBuilder = null;

    function highlightSelection(range) {
        var newNode = document.createElement("div");
        newNode.setAttribute(
            "class",
            "highlighter-class"
        )
        newNode.setAttribute(
            "style",
            "background-color: yellow; display: inline;"
        );
        range.surroundContents(newNode);
    }

    function confirmAnnotation() {
        console.log("Confirming selection:", window.getSelection().toString());
        annotationBuilder = new AnnotationBuilder().highlight();
        var annotationJSON = annotationBuilder.toJSON();
        console.log(annotationJSON);
        highlightSelection(window.getSelection().getRangeAt(0));
        document.getElementById("confirm-annotation-box").style.display = "none";
        var annotationBox = document.getElementById("annotation-box");
        annotationBox.style.display = "block";
        annotationBox.style.left = event.clientX;
        annotationBox.style.top = event.clientY;
    }

    function sendAnnotation() {
        var annotationComment = document.getElementById("annotation-comment").value;
        console.log(annotationComment, annotationBuilder.toJSON());
        document.getElementById("annotation-box").style.display = "none";
        document.getElementById("annotation-comment").value = "";
    }

    function cancelAnnotation() {
        // clear all
        var divs = document.getElementsByClassName("highlighter-class");
        var array = new Array();
        for (var div of divs) {
            array.push(div);
        }
        while (array.length>0) {
            var div = array.pop()
            div.outerHTML = div.innerHTML;
        }
        document.getElementById("annotation-box").style.display = "none";
        document.getElementById("annotation-comment").value = "";
    }

    document.addEventListener("mouseup", function (event) {
        console.log("Mouse up at", event.clientX, event.clientY);

        var confirmAnnotationBox = document.getElementById("confirm-annotation-box");

        if (window.getSelection().toString().length == 0) {
            confirmAnnotationBox.style.display = "none";
        } else if (confirmAnnotationBox.style.display == "none") {
            confirmAnnotationBox.style.display = "block";
            confirmAnnotationBox.style.left = event.clientX;
            confirmAnnotationBox.style.top = event.clientY;
        }

    });

</script>

</html>